from unittest.mock import patch

from django.test import TestCase
from requests import Session

from instagram.services import scrape_posts_instagram, update_post
from ..factories import InstagramPostFactory, InstagramAccountFactory
from ..models import InstagramPost

GET_POST = {
    "data": {"shortcode_media": {"edge_media_preview_like": {"count": 42, "edges": []}}},
}

GET_POSTS = {
    "data": {
        "user": {
            "edge_owner_to_timeline_media": {
                "edges": [
                    {
                        "node": {
                            "__typename": "GraphImage",
                            "id": "2329244848043350818",
                            "display_url": "",
                            "shortcode": "CBTI9kyiFsi",
                            "taken_at_timestamp": 1591887645,
                            "edge_media_to_caption": {
                                "edges": [
                                    {
                                        "node": {
                                            "text": "–ö—Ç–æ –º–æ–∂–µ—Ç –∑–Ω–∞—Ç—å –æ –¥–æ–º–∞—Ö –°—Ç—Ä–∞–Ω—ã –±–æ–ª—å—à–µ, —á–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏?\n‚†Ä\nC–µ–≥–æ–¥–Ω—è –Ω–∞—à –≥–µ—Ä–æ–∏ÃÜ ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –ê–Ω–Ω–∞ –ê–ª—Ç—É—Ö–æ–≤–∞, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–±—Ä–∞–ª–∞ –¥–ª—è —Å–µ–±—è –∏ —Å–≤–æ–µ–∏ÃÜ —Å–µ–º—å–∏ –ó–≤–µ–∑–¥–Ω—ã–∏ÃÜüëáüèª\n‚†Ä\nüåü–ö–∞–∫ —É–∑–Ω–∞–ª–∞ –ø—Ä–æ –ó–≤–µ–∑–¥–Ω—ã–∏ÃÜ\n–Ø —É–∑–Ω–∞–ª–∞ –æ –°—Ç—Ä–∞–Ω–µ –∏–∑ —Ä–µ–∫–ª–∞–º—ã —Å–∞–∏ÃÜ—Ç–∞ –ø–∞—Ä—É –ª–µ—Ç –Ω–∞–∑–∞–¥. –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–ª–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º –∏ –Ω–∞—Ç–∫–Ω—É–ª–∞—Å—å –Ω–∞ –±–∞–Ω–Ω–µ—Ä –ó–≤–µ–∑–¥–Ω–æ–≥–æ. –ú–µ–Ω—è –≤–ø–µ—á–∞—Ç–ª–∏–ª –≤–∏–∑—É–∞–ª –∫–æ–º–ø–ª–µ–∫—Å–∞ –∏ –æ—á–µ–Ω—å –ø—Ä–∏–≤–ª–µ–∫–ª–∞ –º–∞—Å—à—Ç–∞–±–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞.\n‚†Ä\nüåü–ß—Ç–æ –ø–æ–≤–ª–∏—è–ª–æ –Ω–∞ –≤—ã–±–æ—Ä\n–ú—ã —Å —Ä–µ–±–µ–Ω–∫–æ–º –ø—Ä–∏–µ—Ö–∞–ª–∏, –ø—Ä–æ–≥—É–ª—è–ª–∏—Å—å, –∏ —É–∂–µ —Ç–æ–≥–¥–∞ —è –æ—â—É—Ç–∏–ª–∞ —Ç–æ—Ç –∫–æ–º—Ñ–æ—Ä—Ç –∏ —É—é—Ç, –∫–æ—Ç–æ—Ä—ã–∏ÃÜ –ó–≤–µ–∑–¥–Ω—ã–∏ÃÜ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∂–∏—Ç–µ–ª—è–º. –ú–Ω–µ –±—ã–ª–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –±—ã–ª–æ –Ω–µ —Ç–æ–ª—å–∫–æ –º–Ω–µ, –Ω–æ –∏ –º–æ–µ–º—É —Ä–µ–±–µ–Ω–∫—É ‚Äî —ç—Ç–∏ –º–æ–º–µ–Ω—Ç—ã —è –¥–ª—è —Å–µ–±—è —Å—Ä–∞–∑—É –æ—Ç–º–µ—Ç–∏–ª–∞. –£ –º–µ–Ω—è –¥–∞–∂–µ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–ª–æ –º—ã—Å–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏—Ö –∑–∞—Å—Ç—Ä–æ–∏ÃÜ—â–∏–∫–æ–≤ ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã–ª–æ –ø—Ä–æ—Å—Ç–æ —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ —Å–µ–∏ÃÜ—á–∞—Å –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ.\n‚†Ä\nüåü–ó–∞ —á—Ç–æ –ª—é–±–∏—Ç—å –ó–≤–µ–∑–¥–Ω—ã–∏ÃÜ\n1. –£—é—Ç. –ö–æ–≥–¥–∞ –≤—ã –∑–∞–µ–∑–∂–∞–µ—Ç–µ, –≤—ã —Å—Ä–∞–∑—É –æ—â—É—â–∞–µ—Ç–µ —ç—Ç—É –æ—Å–æ–±—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –≤–∞—Å –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç.\n2. –ï–≤—Ä–æ—Ñ–æ—Ä–º–∞—Ç. –ù–∞ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ —Å –±–æ–ª—å—à–æ–∏ÃÜ –∫—É—Ö–Ω–µ–∏ÃÜ-–≥–æ—Å—Ç–∏–Ω–æ–∏ÃÜ –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ –≤ –ó–≤–µ–∑–¥–Ω–æ–º, –¥–∞ –∏ —Å–µ–∏ÃÜ—á–∞—Å —Ç–∞–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ÃÜ –Ω–µ —Ç–∞–∫ –º–Ω–æ–≥–æ.\n3. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Å–∞–º–æ–≥–æ –º–∏–∫—Ä–æ—Ä–∞–∏ÃÜ–æ–Ω–∞. –ì–æ—Ä–æ–¥ –≤ –≥–æ—Ä–æ–¥–µ ‚Äî –≤—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä—è–¥–æ–º.\n‚†Ä\nüåü–ú–æ–∏ÃÜ —Å–æ–≤–µ—Ç\n–í –ó–≤–µ–∑–¥–Ω—ã–∏ÃÜ –Ω—É–∂–Ω–æ –ø—Ä–∏–µ—Ö–∞—Ç—å –∏ —É–≤–∏–¥–µ—Ç—å –≤—Å–µÃà —Å–≤–æ–∏–º–∏ –≥–ª–∞–∑–∞–º–∏. –ò –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–æ–∑—å–º–∏—Ç–µ –¥–µ—Ç–µ–∏ÃÜ!\n‚†Ä\n#–∂–∏–≤—É_–≤_–°—Ç—Ä–∞–Ω–µ #–∑–≤—ë–∑–¥–Ω—ã–π_–≥–æ—Ä–æ–¥–æ–∫"
                                        }
                                    }
                                ]
                            },
                            "edge_media_preview_like": {"count": 223, "edges": []},
                        }
                    },
                    {
                        "node": {
                            "__typename": "GraphSidecar",
                            "id": "2326372761486233794",
                            "display_url": "",
                            "edge_media_to_caption": {
                                "edges": [
                                    {
                                        "node": {
                                            "text": "–ö—Ç–æ –º–æ–∂–µ—Ç –∑–Ω–∞—Ç—å –æ –¥–æ–º–∞—Ö –°—Ç—Ä–∞–Ω—ã –±–æ–ª—å—à–µ, —á–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏?\n‚†Ä\nC–µ–≥–æ–¥–Ω—è –Ω–∞—à –≥–µ—Ä–æ–∏ÃÜ ‚Äî —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –ê–Ω–Ω–∞ –ê–ª—Ç—É—Ö–æ–≤–∞, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–±—Ä–∞–ª–∞ –¥–ª—è —Å–µ–±—è –∏ —Å–≤–æ–µ–∏ÃÜ —Å–µ–º—å–∏ –ó–≤–µ–∑–¥–Ω—ã–∏ÃÜüëáüèª\n‚†Ä\nüåü–ö–∞–∫ —É–∑–Ω–∞–ª–∞ –ø—Ä–æ –ó–≤–µ–∑–¥–Ω—ã–∏ÃÜ\n–Ø —É–∑–Ω–∞–ª–∞ –æ –°—Ç—Ä–∞–Ω–µ –∏–∑ —Ä–µ–∫–ª–∞–º—ã —Å–∞–∏ÃÜ—Ç–∞ –ø–∞—Ä—É –ª–µ—Ç –Ω–∞–∑–∞–¥. –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–ª–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º –∏ –Ω–∞—Ç–∫–Ω—É–ª–∞—Å—å –Ω–∞ –±–∞–Ω–Ω–µ—Ä –ó–≤–µ–∑–¥–Ω–æ–≥–æ. –ú–µ–Ω—è –≤–ø–µ—á–∞—Ç–ª–∏–ª –≤–∏–∑—É–∞–ª –∫–æ–º–ø–ª–µ–∫—Å–∞ –∏ –æ—á–µ–Ω—å –ø—Ä–∏–≤–ª–µ–∫–ª–∞ –º–∞—Å—à—Ç–∞–±–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞.\n‚†Ä\nüåü–ß—Ç–æ –ø–æ–≤–ª–∏—è–ª–æ –Ω–∞ –≤—ã–±–æ—Ä\n–ú—ã —Å —Ä–µ–±–µ–Ω–∫–æ–º –ø—Ä–∏–µ—Ö–∞–ª–∏, –ø—Ä–æ–≥—É–ª—è–ª–∏—Å—å, –∏ —É–∂–µ —Ç–æ–≥–¥–∞ —è –æ—â—É—Ç–∏–ª–∞ —Ç–æ—Ç –∫–æ–º—Ñ–æ—Ä—Ç –∏ —É—é—Ç, –∫–æ—Ç–æ—Ä—ã–∏ÃÜ –ó–≤–µ–∑–¥–Ω—ã–∏ÃÜ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∂–∏—Ç–µ–ª—è–º. –ú–Ω–µ –±—ã–ª–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ –±—ã–ª–æ –Ω–µ —Ç–æ–ª—å–∫–æ –º–Ω–µ, –Ω–æ –∏ –º–æ–µ–º—É —Ä–µ–±–µ–Ω–∫—É ‚Äî —ç—Ç–∏ –º–æ–º–µ–Ω—Ç—ã —è –¥–ª—è —Å–µ–±—è —Å—Ä–∞–∑—É –æ—Ç–º–µ—Ç–∏–ª–∞. –£ –º–µ–Ω—è –¥–∞–∂–µ –Ω–µ –≤–æ–∑–Ω–∏–∫–∞–ª–æ –º—ã—Å–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏—Ö –∑–∞—Å—Ç—Ä–æ–∏ÃÜ—â–∏–∫–æ–≤ ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã–ª–æ –ø—Ä–æ—Å—Ç–æ —É–≤–∏–¥–µ—Ç—å, —á—Ç–æ —Å–µ–∏ÃÜ—á–∞—Å –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ.\n‚†Ä\nüåü–ó–∞ —á—Ç–æ –ª—é–±–∏—Ç—å –ó–≤–µ–∑–¥–Ω—ã–∏ÃÜ\n1. –£—é—Ç. –ö–æ–≥–¥–∞ –≤—ã –∑–∞–µ–∑–∂–∞–µ—Ç–µ, –≤—ã —Å—Ä–∞–∑—É –æ—â—É—â–∞–µ—Ç–µ —ç—Ç—É –æ—Å–æ–±—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É, –∫–æ—Ç–æ—Ä–∞—è –≤–∞—Å –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç.\n2. –ï–≤—Ä–æ—Ñ–æ—Ä–º–∞—Ç. –ù–∞ —Ç–æ—Ç –º–æ–º–µ–Ω—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ —Å –±–æ–ª—å—à–æ–∏ÃÜ –∫—É—Ö–Ω–µ–∏ÃÜ-–≥–æ—Å—Ç–∏–Ω–æ–∏ÃÜ –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ –≤ –ó–≤–µ–∑–¥–Ω–æ–º, –¥–∞ –∏ —Å–µ–∏ÃÜ—á–∞—Å —Ç–∞–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏ÃÜ –Ω–µ —Ç–∞–∫ –º–Ω–æ–≥–æ.\n3. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è —Å–∞–º–æ–≥–æ –º–∏–∫—Ä–æ—Ä–∞–∏ÃÜ–æ–Ω–∞. –ì–æ—Ä–æ–¥ –≤ –≥–æ—Ä–æ–¥–µ ‚Äî –≤—Å—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä—è–¥–æ–º.\n‚†Ä\nüåü–ú–æ–∏ÃÜ —Å–æ–≤–µ—Ç\n–í –ó–≤–µ–∑–¥–Ω—ã–∏ÃÜ –Ω—É–∂–Ω–æ –ø—Ä–∏–µ—Ö–∞—Ç—å –∏ —É–≤–∏–¥–µ—Ç—å –≤—Å–µÃà —Å–≤–æ–∏–º–∏ –≥–ª–∞–∑–∞–º–∏. –ò –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–æ–∑—å–º–∏—Ç–µ –¥–µ—Ç–µ–∏ÃÜ!\n‚†Ä\n#–∂–∏–≤—É_–≤_–°—Ç—Ä–∞–Ω–µ #–∑–≤—ë–∑–¥–Ω—ã–π_–≥–æ—Ä–æ–¥–æ–∫"
                                        }
                                    }
                                ]
                            },
                            "shortcode": "CBI77NviBDC",
                            "taken_at_timestamp": 1591545265,
                            "edge_media_preview_like": {"count": 86, "edges": []},
                            "edge_sidecar_to_children": {
                                "edges": [
                                    {
                                        "node": {
                                            "__typename": "GraphImage",
                                            "id": "2326372755672963175",
                                            "display_url": "",
                                        }
                                    },
                                    {
                                        "node": {
                                            "__typename": "GraphImage",
                                            "id": "2326372755689774332",
                                            "display_url": "",
                                        }
                                    },
                                ]
                            },
                        }
                    },
                ]
            }
        }
    }
}


class MockResponse:
    def __init__(self, json_data, status_code, cookies):
        self.json_data = json_data
        self.status_code = status_code
        self.cookies = cookies

    def json(self):
        return self.json_data

    def raise_for_status(self):
        return


def mocked_scrape_posts_instagram(*args, **kwargs):

    if args[0] == "https://www.instagram.com/":
        return MockResponse({}, 200, {"csrftoken": 1})
    elif (
        args[0]
        == """https://www.instagram.com/graphql/query/?query_hash=eddbde960fed6bde675388aac39a3657&variables={"id":"3241043704","first":12}"""
    ):
        return MockResponse(GET_POSTS, 200, {"csrftoken": 1})

    return MockResponse(None, 404, {"csrftoken": 1})


def mocked_update_post(*args, **kwargs):

    if args[0] == "https://www.instagram.com/":
        return MockResponse({}, 200, {"csrftoken": 1})
    elif (
        args[0]
        == """https://www.instagram.com/graphql/query/?query_hash=8061d8ba6866a69b02600d467920ed5c&variables={"shortcode":"123"}"""
    ):
        return MockResponse(GET_POST, 200, {"csrftoken": 1})

    return MockResponse(None, 404, {"csrftoken": 1})


class ServiceTest(TestCase):
    @patch.object(Session, "get", side_effect=mocked_scrape_posts_instagram)
    def test_scrape_posts_instagram(self, mock_session_get):
        account = InstagramAccountFactory()
        account.id = 3241043704
        account.first = 12
        account.save()
        scrape_posts_instagram(account.id, account.first)
        self.assertEqual(InstagramPost.objects.count(), 2)

    @patch.object(Session, "get", side_effect=mocked_update_post)
    def test_update_post(self, mock_session_get):
        p = InstagramPostFactory(shortcode="123", likes=0)
        update_post("123")
        p.refresh_from_db()
        self.assertEqual(p.likes, 42)
